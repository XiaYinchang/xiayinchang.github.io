<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="Better" type="application/atom+xml">
  <meta name="google-site-verification" content="50AFVzX5Un8aV_39ECS7O1HvI536wZfrbUXfXmZC1uI">
  <meta name="baidu-site-verification" content="jbuVi0osTz">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: "",
      labels: ""
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="本文记录 Kubernetes 相关的操作命令和实践方法。">
<meta name="keywords" content="Kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 实践">
<meta property="og:url" content="https:&#x2F;&#x2F;www.xiayinchang.top&#x2F;post&#x2F;9caa466a.html">
<meta property="og:site_name" content="Better">
<meta property="og:description" content="本文记录 Kubernetes 相关的操作命令和实践方法。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;cdn.nlark.com&#x2F;yuque&#x2F;0&#x2F;2020&#x2F;png&#x2F;182657&#x2F;1586427070015-35b14a0a-4cf8-48cf-ae25-db4531f0b8b1.png#align=left&amp;display=inline&amp;height=824&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=824&amp;originWidth=983&amp;size=117967&amp;status=done&amp;style=none&amp;width=983">
<meta property="og:image" content="https:&#x2F;&#x2F;cdn.nlark.com&#x2F;yuque&#x2F;0&#x2F;2020&#x2F;png&#x2F;182657&#x2F;1586427180951-d8f9d830-5f94-4bb3-bbd6-640dd513b3f2.png#align=left&amp;display=inline&amp;height=363&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=363&amp;originWidth=924&amp;size=65129&amp;status=done&amp;style=none&amp;width=924">
<meta property="og:updated_time" content="2020-08-26T16:00:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;cdn.nlark.com&#x2F;yuque&#x2F;0&#x2F;2020&#x2F;png&#x2F;182657&#x2F;1586427070015-35b14a0a-4cf8-48cf-ae25-db4531f0b8b1.png#align=left&amp;display=inline&amp;height=824&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=824&amp;originWidth=983&amp;size=117967&amp;status=done&amp;style=none&amp;width=983">

<link rel="canonical" href="https://www.xiayinchang.top/post/9caa466a.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Kubernetes 实践 | Better</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Better</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/xiayinchang" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.xiayinchang.top/post/9caa466a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏印昌">
      <meta itemprop="description" content="云计算从业者，全栈攻城狮">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Better">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          Kubernetes 实践
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-13 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-13T00:00:00+08:00">2019-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-27 00:00:00" itemprop="dateModified" datetime="2020-08-27T00:00:00+08:00">2020-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>21 分钟</span>
            </span>
            <div class="post-description">本文记录 Kubernetes 相关的操作命令和实践方法。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a name="JlHqj"></a></p><h4 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用原始 URL 获取资源信息</span></span><br><span class="line">kubectl get --raw <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes"</span></span><br><span class="line"><span class="comment"># 定制输出列</span></span><br><span class="line">kubectl get nodes -o=custom-columns=NAME:.metadata.name,TAINTS:.spec.taints</span><br></pre></td></tr></table></figure><a id="more"></a>

<p><a name="gFpih"></a></p>
<h4 id="Patch-更新的三种操作"><a href="#Patch-更新的三种操作" class="headerlink" title="Patch 更新的三种操作"></a>Patch 更新的三种操作</h4><p>如下为 kubectl patch 命令更新资源的基本形式，其中 type 有三种 json/merge/strategic：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch xxxx --<span class="built_in">type</span> xxxx --patch xxxx</span><br></pre></td></tr></table></figure>

<ul>
<li><p>标准的 json patch，Content-Type: application/json-patch+json：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch deployments patch-demo --<span class="built_in">type</span> json --patch <span class="string">'[&#123;"op":"replace", "path":"/spec/replicas", "value":4&#125;]'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>标准的 json merge patch，Content-Type: application/merge-json-patch+json，执行局部替换：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat prometheus-patch.yaml</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: uhub.service.ucloud.cn/uk8s_public/prometheus:<span class="built_in">test</span></span><br><span class="line">        name: prometheus</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下命令会将整个 containers 列表替换掉</span></span><br><span class="line">$ kubectl patch deployment prometheus-k8s --<span class="built_in">type</span> merge --patch <span class="string">"<span class="variable">$(cat prometheus-patch.yaml)</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>JSON strategic merge patch，增量形式更新对象，默认策略是执行替换，实际策略与属性的标签有关：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ cat patch-file-containers.yaml</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: patch-demo-ctr-2</span><br><span class="line">        image: redis</span><br><span class="line">        </span><br><span class="line">$ kubectl patch deployment patch-demo --patch <span class="string">"<span class="variable">$(cat patch-file-containers.yaml)</span>"</span></span><br><span class="line"><span class="comment"># 可以看到新增了容器，而不是替换了容器列表</span></span><br><span class="line">$ kubectl get deployment patch-demo -o yaml</span><br><span class="line">   containers:</span><br><span class="line">      - image: redis</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: patch-demo-ctr-2</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">      - image: nginx</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: patch-demo-ctr</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 这是因为在类型定义的标签中定义了 Containers 属性的 patchStrategy 为 merge，因此未执行默认替换策略</span></span><br><span class="line"> <span class="comment"># 而如果 patch 内容中包含 Tolerations 列表，则 Tolerations 会被替换</span></span><br><span class="line"> <span class="built_in">type</span> PodSpec struct &#123;</span><br><span class="line">  ...</span><br><span class="line">  Containers []Container `json:<span class="string">"containers"</span> patchStrategy:<span class="string">"merge"</span> patchMergeKey:<span class="string">"name"</span> ...`</span><br><span class="line">  Tolerations []Toleration `json:<span class="string">"tolerations,omitempty"</span> opt,name=tolerations<span class="string">"`</span></span><br></pre></td></tr></table></figure>
<p><a name="XUXYp"></a></p>
<h4 id="taint"><a href="#taint" class="headerlink" title="taint"></a>taint</h4></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 去除所有节点 mater taint 使之可调度</span></span><br><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br><span class="line"><span class="comment"># 为节点添加 taint</span></span><br><span class="line">kubectl taint nodes node1 node-role.kubernetes.io/master=:NoSchedule</span><br></pre></td></tr></table></figure>


<p><a name="O6MDK"></a></p>
<h4 id="toleration"><a href="#toleration" class="headerlink" title="toleration"></a>toleration</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容忍所有</span></span><br><span class="line">tolerations:</span><br><span class="line">- operator: <span class="string">"Exists"</span></span><br></pre></td></tr></table></figure>


<p><a name="QJzQf"></a></p>
<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><ul>
<li>命令行读写<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">export ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">export ETCDCTL_CERT=/etc/kubernetes/pki/etcd/healthcheck-client.crt</span><br><span class="line">export ETCDCTL_KEY=/etc/kubernetes/pki/etcd/healthcheck-client.key</span><br><span class="line">export ETCDCTL_ENDPOINTS=192.168.180.7:2379,192.168.180.8:2379,192.168.180.9:2379</span><br><span class="line">// 列出所有键值对</span><br><span class="line">etcdctl get &quot;&quot; --prefix=true</span><br><span class="line">etcdctl get &quot;&quot; --from-key</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>备份<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key snapshot save etcd-snapshot.db</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>磁盘读写速度过慢造成的故障</li>
</ul>
<p>如果 etcd pod 的 log 中会存在大量的类似 “etcdserver: read-only range request “key:…” with result “…” took too long (…) to execute” 的报错，大概率是磁盘损坏造成的读写速度过慢导致的，etcd 的数据存储在 /var/lib/etcd 目录下。</p>
<ul>
<li>删除节点<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member list</span><br><span class="line">etcdctl member remove member_id</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>check cluster health</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl endpoint health</span><br></pre></td></tr></table></figure>
</li>
<li><p>etcd 故障恢复</p>
</li>
</ul>
<p>注意：对于断电或系统意外崩溃的情况可尝试重启 etcd ，如果重启无法解决再使用备份进行恢复。<br>参考：<a href="https://blog.csdn.net/dazuiba008/article/details/94595679" target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/dazuiba008/article/details/94595679</a><br><a name="YMk0B"></a></p>
<h4 id="nodeName-nodeSelector-Affinity"><a href="#nodeName-nodeSelector-Affinity" class="headerlink" title="nodeName/nodeSelector/Affinity"></a>nodeName/nodeSelector/Affinity</h4><p>直接指定 nodeName 后 Pod 将被视为已调度而不再经过调度器进行调度；nodeSelector 通过节点标签来指定 Pod 调度到相应节点上去，是较为简单的一种方式；Affinity 支持逻辑表达式实现更复杂的调度逻辑，且可设置不具强制性的软亲和，还可以设置 Pod 之间的亲和与反亲和特性。<br><a name="qFuF6"></a></p>
<h4 id="逻辑上的隔离"><a href="#逻辑上的隔离" class="headerlink" title="逻辑上的隔离"></a>逻辑上的隔离</h4><p>可通过配置限制 kubelet 在启动时设置节点的某些具有特殊前缀的标签，例如 <code>node-role.kubernetes.io/master, node-restriction.kubernetes.io/</code> 等，这些标签只能在节点加入集群后由具有集群管理员权限的用户添加上去，配合 <code>nodeSelector/Affinity</code> 可以实现 Pod 在逻辑上的一种隔离，将具有不同安全等级要求的 Pod 调度到不同的节点上去。<br><a name="AgXdq"></a></p>
<h4 id="节点状态和-Taint"><a href="#节点状态和-Taint" class="headerlink" title="节点状态和 Taint"></a>节点状态和 Taint</h4><p>当节点 Condition 中的最后一项即 Type 为 Ready 这一项，其 Status 值为 False 时，controller-manager 中的 node-controller 会自动为节点添加 key 为 node.kubernetes.io/not-ready 的 taint；当其 Status 值为 Unknown 时，自动添加 key 为 node.kubernetes.io/unreachable 的 taint。当 taint effect 为 NoExecute，会驱逐运行在问题节点上的 Pod。参考：<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank" rel="external nofollow noopener noreferrer">https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/</a>。<br><a name="xcw1D"></a></p>
<h4 id="Kubernetes-go-client"><a href="#Kubernetes-go-client" class="headerlink" title="Kubernetes-go-client"></a>Kubernetes-go-client</h4><ul>
<li>更新 api 对象的两种方式<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"k8s.io/apimachinery/pkg/types"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">patch, err := json.Marshal([]common.JsonPatchSpec&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Op:    <span class="string">"replace"</span>,</span><br><span class="line">        Path:  <span class="string">"/spec/suspend"</span>,</span><br><span class="line">        Value: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">_, err = common.CronClient.CronJobs(config.UMStorInfraNamespace).Patch(in.GetName(), types.JSONPatchType, patch)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用 update</span></span><br><span class="line"><span class="comment">// 先按需修改 originDeploy 中的内容，关键是要重建 objectmeta</span></span><br><span class="line">_, err = common.AppsClient.Deployments(config.UMStorInfraNamespace).Update(&amp;k8s_apps_api.Deployment&#123;</span><br><span class="line">    ObjectMeta: k8s_metav1.ObjectMeta&#123;</span><br><span class="line">        Name:            in.Name,</span><br><span class="line">        ResourceVersion: originDeploy.ResourceVersion,</span><br><span class="line">        Labels:          originDeploy.Labels,</span><br><span class="line">    &#125;,</span><br><span class="line">    Spec: originDeploy.Spec,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p><a name="kPMVq"></a></p>
<h4 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h4><ul>
<li>为 Ingress Host 生成自签名证书<ul>
<li>简易方法</li>
</ul>
</li>
</ul>
<p>参考：<a href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/" target="_blank" rel="external nofollow noopener noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/tls/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KEY_FILE=dashboard_key</span><br><span class="line">CERT_FILE=dashboard_cert</span><br><span class="line">CERT_NAME=dashboard_tls</span><br><span class="line">HOST=kubernetes-dashboard.test</span><br><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout <span class="variable">$&#123;KEY_FILE&#125;</span> -out <span class="variable">$&#123;CERT_FILE&#125;</span> -subj <span class="string">"/CN=<span class="variable">$&#123;HOST&#125;</span>/O=<span class="variable">$&#123;HOST&#125;</span>"</span></span><br><span class="line">kubectl create secret tls <span class="variable">$&#123;CERT_NAME&#125;</span> --key <span class="variable">$&#123;KEY_FILE&#125;</span> --cert <span class="variable">$&#123;CERT_FILE&#125;</span></span><br></pre></td></tr></table></figure>


<ul>
<li>定制</li>
</ul>
<p>参考： <a href="https://mritd.me/2017/03/04/how-to-use-nginx-ingress/" target="_blank" rel="external nofollow noopener noreferrer">https://mritd.me/2017/03/04/how-to-use-nginx-ingress/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 CA 自签证书 ， 也可以直接使用 /etc/kubernetes/pki/ 下的 CA 证书</span></span><br><span class="line">mkdir cert &amp;&amp; <span class="built_in">cd</span> cert</span><br><span class="line">openssl genrsa -out ca-key.pem 2048</span><br><span class="line">openssl req -x509 -new -nodes -key ca-key.pem -days 10000 -out ca.pem -subj <span class="string">"/CN=kube-ca"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 openssl 配置</span></span><br><span class="line">cp /etc/pki/tls/openssl.cnf .</span><br><span class="line">vim openssl.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主要修改如下</span></span><br><span class="line">[req]</span><br><span class="line">req_extensions = v3_req <span class="comment"># 这行默认注释关着的 把注释删掉</span></span><br><span class="line"><span class="comment"># 下面配置是新增的</span></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = harbor.sh.umcloud.network</span><br><span class="line">DNS.2 = gitlab.sh.umcloud.network</span><br><span class="line">DNS.3 = minio.sh.umcloud.network</span><br><span class="line">DNS.4 = registry.sh.umcloud.network</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书</span></span><br><span class="line">openssl genrsa -out ingress-key.pem 2048</span><br><span class="line">openssl req -new -key ingress-key.pem -out ingress.csr -subj <span class="string">"/CN=kube-ingress"</span> -config openssl.cnf</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> ingress.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out ingress.pem -days 365 -extensions v3_req -extfile openssl.cnf</span><br><span class="line">kubectl create secret tls gitlab-ce-gitlab-tls --key ingress-key.pem --cert ingress.pem -n gitlab-ce</span><br></pre></td></tr></table></figure>


<ul>
<li>查看证书内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in ca.crt -text -noout</span><br><span class="line">openssl s_client -showcerts -connect www.baidu.com:443</span><br></pre></td></tr></table></figure>


<ul>
<li>检查证书过期时间</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha certs check-expiration</span><br></pre></td></tr></table></figure>


<p><a name="xUZC5"></a></p>
<h4 id="Kubeadm"><a href="#Kubeadm" class="headerlink" title="Kubeadm"></a>Kubeadm</h4><ul>
<li>kubeadm join … -v 10</li>
</ul>
<p>kubeadm 添加第二个 master 节点时出现以下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I0724 10:27:10.396559   31977 token.go:141] [discovery] Requesting info from <span class="string">"https://192.168.2.65:6445"</span> again to validate TLS against the pinned public key</span><br><span class="line">I0724 10:27:10.397359   31977 round_trippers.go:419] curl -k -v -XGET  -H <span class="string">"User-Agent: kubeadm/v1.14.1 (linux/amd64) kubernetes/b739410"</span> -H <span class="string">"Accept: application/json, */*"</span> <span class="string">'https://192.168.2.65:6445/api/v1/namespaces/kube-public/configmaps/cluster-info'</span></span><br><span class="line">I0724 10:27:10.403962   31977 round_trippers.go:438] GET https://192.168.2.65:6445/api/v1/namespaces/kube-public/configmaps/cluster-info  <span class="keyword">in</span> 6 milliseconds</span><br><span class="line">I0724 10:27:10.403989   31977 round_trippers.go:444] Response Headers:</span><br><span class="line">I0724 10:27:10.404036   31977 token.go:147] [discovery] Failed to request cluster info, will try again: [Get https://192.168.2.65:6445/api/v1/namespaces/kube-public/configmaps/cluster-info: x509: certificate has expired or is not yet valid]</span><br></pre></td></tr></table></figure>
<p>错误表明 kubeadm 已经成功从 kube-public 命名空间下的 cluster-info confgimap 中获取到了集群信息，然后在验证集群证书的有效性时出错。<code>x509: certificate has expired or is not yet valid</code> 一般是由于系统时间错误导致，可以先用 date 命令确定本地时间是否正确。如果本地时间错误，可以尝试使用 ntp 同步系统时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ntpdate cn.pool.ntp.org</span><br><span class="line">// 如果找不到 ntp 命令，可以使用如下的命令进行安装</span><br><span class="line">yum instal ntp</span><br></pre></td></tr></table></figure>


<ul>
<li>kubeadm 部署时 config 文件</li>
</ul>
<p>参考：<a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2" target="_blank" rel="external nofollow noopener noreferrer">https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</a>，kubelet 自定义配置参考：<a href="https://godoc.org/k8s.io/kubelet/config/v1beta1#KubeletConfiguration" target="_blank" rel="external nofollow noopener noreferrer">https://godoc.org/k8s.io/kubelet/config/v1beta1#KubeletConfiguration</a>。一个需要注意的地方是<br>一个单 master 节点集群配置参考，需要注意的是虽然在下面的配置中已经设置了 failSwapOn 为 false，但是 kubeadm 并不会去检测该配置，仍然会报错，不过该报错可以被忽略，因为这个设置随后确实会被添加到 kubelet 的配置中并生效，因此 init 时执行 <code>sudo kubeadm init --config kubeadm.yml --ignore-preflight-errors=all</code> 即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">imageRepository: gcr.azk8s.cn/google-containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.0</span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">apiServer:</span><br><span class="line">  extraArgs:</span><br><span class="line">    <span class="built_in">bind</span>-address: 0.0.0.0</span><br><span class="line">    feature-gates: <span class="string">"EphemeralContainers=true"</span></span><br><span class="line">  extraVolumes:</span><br><span class="line">  - name: <span class="string">"timezone"</span></span><br><span class="line">    hostPath: <span class="string">"/etc/localtime"</span></span><br><span class="line">    mountPath: <span class="string">"/etc/localtime"</span></span><br><span class="line">    readOnly: <span class="literal">true</span></span><br><span class="line">    pathType: File</span><br><span class="line">controllerManager:</span><br><span class="line">  extraArgs:</span><br><span class="line">    <span class="built_in">bind</span>-address: 0.0.0.0</span><br><span class="line">    feature-gates: <span class="string">"EphemeralContainers=true"</span></span><br><span class="line">  extraVolumes:</span><br><span class="line">  - name: <span class="string">"timezone"</span></span><br><span class="line">    hostPath: <span class="string">"/etc/localtime"</span></span><br><span class="line">    mountPath: <span class="string">"/etc/localtime"</span></span><br><span class="line">    readOnly: <span class="literal">true</span></span><br><span class="line">    pathType: File</span><br><span class="line">scheduler:</span><br><span class="line">  extraArgs:</span><br><span class="line">    address: 0.0.0.0</span><br><span class="line">    feature-gates: <span class="string">"EphemeralContainers=true"</span></span><br><span class="line">  extraVolumes:</span><br><span class="line">  - name: <span class="string">"timezone"</span></span><br><span class="line">    hostPath: <span class="string">"/etc/localtime"</span></span><br><span class="line">    mountPath: <span class="string">"/etc/localtime"</span></span><br><span class="line">    readOnly: <span class="literal">true</span></span><br><span class="line">    pathType: File</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clusterCIDR: 10.244.0.0/16</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: <span class="literal">false</span></span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: rr</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs</span><br><span class="line">---</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">failSwapOn: <span class="literal">false</span></span><br><span class="line">kind: KubeletConfiguration</span><br></pre></td></tr></table></figure>


<ul>
<li>内核配置参考<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[xyc-pc ~]<span class="comment"># cat /etc/modules-load.d/ipvs.conf </span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">nf_conntrack</span><br><span class="line">br_netfilter</span><br><span class="line"></span><br><span class="line">//使其临时生效</span><br><span class="line">ipvs_modules=<span class="string">"ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack br_netfilter"</span>;</span><br><span class="line"><span class="keyword">for</span> kernel_module <span class="keyword">in</span> <span class="variable">$&#123;ipvs_modules&#125;</span>; <span class="keyword">do</span> modprobe <span class="variable">$&#123;kernel_module&#125;</span> &gt; /dev/null 2&gt;&amp;1;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[xyc-pc ~]<span class="comment"># cat /etc/sysctl.conf </span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">vm.swappiness=0</span><br><span class="line">net.core.somaxconn=32768</span><br><span class="line">net.ipv4.tcp_syncookies=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.core.default_qdisc=fq_codel</span><br><span class="line">//使其临时生效</span><br><span class="line">sysctl -p /etc/sysctl.conf</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p><a name="UYIkL"></a></p>
<h4 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h4><ul>
<li><p>从模板生成本地文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir yamls</span><br><span class="line">helm fetch --untar --untardir . &apos;stable/redis&apos; #makes a directory called redis </span><br><span class="line">helm template --output-dir &apos;./yamls&apos; &apos;./redis&apos; #redis dir (local helm chart), export to yamls dir</span><br></pre></td></tr></table></figure>
</li>
<li><p>拉取压缩文件到本地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm fetch ucloud/uk8s-etcd-backup</span><br></pre></td></tr></table></figure>
</li>
<li><p>制作 chart</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜ tree uk8s-etcd-backup</span><br><span class="line">uk8s-etcd-backup</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── configmap.yaml</span><br><span class="line">│   ├── cronjob.yaml</span><br><span class="line">│   └── secret.yaml</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line">helm package uk8s-etcd-backup</span><br></pre></td></tr></table></figure>
<p><a name="b94zX"></a></p>
<h4 id="添加自定义-DNS-记录"><a href="#添加自定义-DNS-记录" class="headerlink" title="添加自定义 DNS 记录"></a>添加自定义 DNS 记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@10-8-62-148 ~]<span class="comment"># kubectl get cm -n kube-system coredns -oyaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        health</span><br><span class="line">        rewrite name harbor.sh.umcloud.network harbor.default.svc.cluster.local</span><br><span class="line">        rewrite name docker.sh.umcloud.network docker.default.svc.cluster.local</span><br><span class="line">        kubernetes cluster.local <span class="keyword">in</span>-addr.arpa ip6.arpa &#123;</span><br><span class="line">           pods insecure</span><br><span class="line">           upstream</span><br><span class="line">           fallthrough <span class="keyword">in</span>-addr.arpa ip6.arpa</span><br><span class="line">           ttl 30</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        forward . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-05T07:29:37Z"</span></span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">[root@10-8-62-148 ~]<span class="comment"># cat umcloud-svc.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: harbor</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      name: http</span><br><span class="line">    - port: 443</span><br><span class="line">      name: https</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  name: harbor</span><br><span class="line">subsets:</span><br><span class="line">  - addresses:</span><br><span class="line">      - ip: 10.8.62.148</span><br><span class="line">    ports:</span><br><span class="line">      - port: 80</span><br><span class="line">        name: http</span><br><span class="line">        protocol: TCP</span><br><span class="line">      - port: 443</span><br><span class="line">        name: https</span><br><span class="line">        protocol: TCP</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p><a name="9BV58"></a></p>
<h4 id="向容器添加-hosts-记录"><a href="#向容器添加-hosts-记录" class="headerlink" title="向容器添加 hosts 记录"></a>向容器添加 hosts 记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: hostaliases-pod</span><br><span class="line">spec:</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">  hostAliases:</span><br><span class="line">  - ip: <span class="string">"127.0.0.1"</span></span><br><span class="line">    hostnames:</span><br><span class="line">    - <span class="string">"foo.local"</span></span><br><span class="line">    - <span class="string">"bar.local"</span></span><br><span class="line">  - ip: <span class="string">"10.1.2.3"</span></span><br><span class="line">    hostnames:</span><br><span class="line">    - <span class="string">"foo.remote"</span></span><br><span class="line">    - <span class="string">"bar.remote"</span></span><br><span class="line">  containers:</span><br><span class="line">  - name: cat-hosts</span><br><span class="line">    image: busybox</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - cat</span><br><span class="line">    args:</span><br><span class="line">    - <span class="string">"/etc/hosts"</span></span><br></pre></td></tr></table></figure>


<p><a name="O0gNe"></a></p>
<h4 id="ingress-nginx"><a href="#ingress-nginx" class="headerlink" title="ingress-nginx"></a>ingress-nginx</h4><ul>
<li><p>为转向上游的请求添加 header：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    ingress.kubernetes.io/configuration-snippet: |-</span><br><span class="line">      <span class="keyword">set</span> $best_http_host "usergate.dev.choicesaas.cn";</span><br><span class="line">      proxy_set_header Host                   $best_http_host;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>nginx 原样传递编码过的 URL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">map &apos;&apos; $seed_uri &#123;</span><br><span class="line">    default $request_uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       8001;</span><br><span class="line">    server_name  _;</span><br><span class="line">    root         /usr/share/nginx/html/;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_pass http://umstor-rgw-customer.storage-system.svc.cluster.local$seed_uri;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义 timeout </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-read-timeout: <span class="string">"1800"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-send-timeout: <span class="string">"1800"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /<span class="variable">$2</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: <span class="string">"false"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>后端服务需要使用 HTTPS 访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/backend-protocol: <span class="string">"HTTPS"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>透传 TLS 握手</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/ssl-passthrough: <span class="string">"true"</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<p><a name="pCtvi"></a></p>
<h4 id="CronJob-与-Job"><a href="#CronJob-与-Job" class="headerlink" title="CronJob 与 Job"></a>CronJob 与 Job</h4><p>建议设置 startingDeadlineSeconds 值以防止从最后一次调度到当前时间错过的调度次数超过 100 导致不再进行调度（使用 etcd 备份数据恢复集群时可能出现这种情况），参考：<a href="https://www.jianshu.com/p/3e3b18414e45" target="_blank" rel="external nofollow noopener noreferrer">https://www.jianshu.com/p/3e3b18414e45</a>。<br>job.spec.ttlSecondsAfterFinished 参数有三种选项：不设置，则 Job 不会被自动删除；设置为 0 ，则在 Job 运行完成后立即自动删除；设置为非零值，则在一定时间后自动删除。<br>cronjob 则通过 cronjob.spec.failedJobsHistoryLimit （默认值为 1 ） 和 cronjob.spec.successfulJobsHistoryLimit （默认值为 3 ） 来控制保存的 Job 数量。<br>job.spec.template.spec.restartPolicy 设置的是 Pod 的重启策略，在 Job 这种一次性任务的场景中，应当设置为 OnFailure 或者 Never，在 Deployment 场景中应当保持默认值 Always。<br>job.spec.backoffLimit 设置的次数指的是 Pod 运行失败后，尝试重新创建 Pod 的次数，不包括第一次运行。例如，设置 backoffLimit 为 2 ，则该 job 相关的 Pod 最多会重试三次（通过依次创建 3 个不同的 Pod实现）。这有别于 job.spec.template.spec.restartPolicy 参数，restartPolicy 是针对同一个 Pod 不停重启重试，而 job.spec.backoffLimit 则是尝试创建新的 Pod。<br></p>
<p><a name="d24JT"></a></p>
<h4 id="field-selector-和-labels-selector"><a href="#field-selector-和-labels-selector" class="headerlink" title="field-selector 和 labels-selector"></a>field-selector 和 labels-selector</h4><p>字段选择器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --field-selector=status.phase!=Running,spec.restartPolicy=Always</span><br><span class="line">kubectl get statefulsets,services --all-namespaces --field-selector metadata.namespace!=default</span><br></pre></td></tr></table></figure>
<p>标签选择器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -l environment=production,tier=frontend</span><br><span class="line">kubectl get pods -l &apos;environment in (production),tier in (frontend)&apos;</span><br><span class="line">kubectl get pods -l &apos;environment in (production, qa)&apos;</span><br><span class="line">kubectl get pods -l &apos;environment,environment notin (frontend)&apos;</span><br><span class="line"># 也可以仅使用标签名选择，而不必指定标签值</span><br><span class="line">kubectl get cm -n monitoring -l prometheus-name</span><br></pre></td></tr></table></figure>


<p><a name="sM7pt"></a></p>
<h4 id="使用-subPath-挂载-Volume"><a href="#使用-subPath-挂载-Volume" class="headerlink" title="使用 subPath 挂载 Volume"></a>使用 subPath 挂载 Volume</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: mysql:5.6</span><br><span class="line">        name: mysql</span><br><span class="line">        env:</span><br><span class="line">          # Use secret in real usage</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: password</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3306</span><br><span class="line">          name: mysql</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-configmap-volume</span><br><span class="line">          mountPath: /etc/mysql/conf.d/binlog_format.cnf</span><br><span class="line">          subPath: binlog_format.cnf</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: mysql-configmap</span><br><span class="line">          items:</span><br><span class="line">          - key: mysql_binlog_format.cnf</span><br><span class="line">            path: binlog_format.cnf</span><br></pre></td></tr></table></figure>


<p><a name="rN7rK"></a></p>
<h4 id="创建并使用-imagePullSecrets"><a href="#创建并使用-imagePullSecrets" class="headerlink" title="创建并使用 imagePullSecrets"></a>创建并使用 imagePullSecrets</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 创建 secret</span><br><span class="line">kubectl create secret docker-registry my-registry --docker-server=my.private.registry --docker-username=test --docker-password=test</span><br><span class="line">// 在 default service account 中使用</span><br><span class="line">[root@cicd03 ~]# kubectl get serviceaccount default -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">imagePullSecrets:</span><br><span class="line">- name: my-registry</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: default</span><br><span class="line">  namespace: default</span><br><span class="line">secrets:</span><br><span class="line">- name: default-token-l9xgs</span><br></pre></td></tr></table></figure>


<p><a name="Fq6Wa"></a></p>
<h4 id="sealos-部署-Kubernetes"><a href="#sealos-部署-Kubernetes" class="headerlink" title="sealos 部署 Kubernetes"></a>sealos 部署 Kubernetes</h4><p>开发测试可以使用 <a href="https://github.com/fanux/sealos" target="_blank" rel="external nofollow noopener noreferrer">sealos</a> 这个工具，通过离线安装包部署 Kubernetes，省心实用，但是作者在改过的 Kubeadm 代码里夹杂了一些私货令人不喜。</p>
<ul>
<li>离线安装包下载链接</li>
</ul>
<table>
<thead>
<tr>
<th>1.17.0</th>
<th><a href="https://sealyun.oss-cn-beijing.aliyuncs.com/413bd3624b2fb9e466601594b4f72072-1.17.0/kube1.17.0.tar.gz" target="_blank" rel="external nofollow noopener noreferrer">https://sealyun.oss-cn-beijing.aliyuncs.com/413bd3624b2fb9e466601594b4f72072-1.17.0/kube1.17.0.tar.gz</a></th>
</tr>
</thead>
<tbody><tr>
<td>1.17.1</td>
<td><a href="https://sealyun.oss-cn-beijing.aliyuncs.com/9347ea4e446ce514dbba6f686034a363-1.17.1/kube1.17.1.tar.gz" target="_blank" rel="external nofollow noopener noreferrer">https://sealyun.oss-cn-beijing.aliyuncs.com/9347ea4e446ce514dbba6f686034a363-1.17.1/kube1.17.1.tar.gz</a></td>
</tr>
<tr>
<td>1.19.0</td>
<td><a href="https://sealyun.oss-cn-beijing.aliyuncs.com/c937a97b72d16653ef25b0b54bdc7131-1.19.0/kube1.19.0.tar.gz" target="_blank" rel="external nofollow noopener noreferrer">https://sealyun.oss-cn-beijing.aliyuncs.com/c937a97b72d16653ef25b0b54bdc7131-1.19.0/kube1.19.0.tar.gz</a></td>
</tr>
</tbody></table>
<ul>
<li>添加 master 节点<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 先安装好 docker， 参见：https://docs.docker.com/install/linux/docker-ce/centos/</span><br><span class="line">systemctl enable --now docker</span><br><span class="line">// 从集群内节点拷贝离线安装包并解压缩</span><br><span class="line">scp 192.168.180.8:./kube1.15.0.tar.gz .</span><br><span class="line">tar zxvf kube1.15.0.tar.gz</span><br><span class="line">// 执行初始化操作</span><br><span class="line">chmod +x ./kube/shell/init.sh</span><br><span class="line">cd kube/shell</span><br><span class="line">./init.sh</span><br><span class="line">// 在 hosts 文件中加入 apiserver 解析</span><br><span class="line">echo &apos;192.168.180.7 apiserver.cluster.local&apos; &gt;&gt; /etc/hosts</span><br><span class="line">// 获取 cert-key </span><br><span class="line">kubeadm init phase upload-certs --upload-certs</span><br><span class="line">// 获取加入集群的命令</span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line">// 拼出 master 节点加入集群的命令并执行</span><br><span class="line">kubeadm join apiserver.cluster.local:6443 --control-plane --certificate-key $CERT_KEY --token f0d79y.lekvh1338tye45d0 --discovery-token-ca-cert-hash sha256:33d4cbc2207ad24c551cbdd0d5b9c70cf42232795d87d7c30054ddb8773c99f6</span><br><span class="line">// 加入成功后替换解析地址为本机 IP</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p><a name="XIbTO"></a></p>
<h4 id="优雅地删除节点"><a href="#优雅地删除节点" class="headerlink" title="优雅地删除节点"></a>优雅地删除节点</h4><p> 删除 master 节点时注意可能需要手动修改 kubeadm-config 中的配置，同时手动修改 /etc/kubernetes/manifests/etcd.yaml 文件移除相关 IP。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl drain &lt;node-name&gt;</span><br><span class="line">kubectl drain &lt;node-name&gt; --ignore-daemonsets --delete-local-data</span><br><span class="line">kubectl delete node &lt;node-name&gt;</span><br></pre></td></tr></table></figure>


<p><a name="z42bx"></a></p>
<h4 id="重启容器而非删除"><a href="#重启容器而非删除" class="headerlink" title="重启容器而非删除"></a>重启容器而非删除</h4><p>删除容器后会重新进行调度，如果希望在同一个宿主机上重新拉起容器可以执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在容器中执行如下命令，会使容器重新创建，但不会重新调度</span></span><br><span class="line"><span class="built_in">kill</span> 1</span><br></pre></td></tr></table></figure>
<p>但需要注意的是，上述命令会造成容器重建，所以在容器中进行的非持久修改均会丢失，若想保留临时修改，可先找到容器所在宿主机，然后登录到宿主机上执行 <code>docker restart</code> 重启会保留临时修改，往往用于调试场景。<br></p>
<p><a name="05Wmk"></a></p>
<h4 id="ServiceAccountTokenVolumeProjection-生成有时效的-Token"><a href="#ServiceAccountTokenVolumeProjection-生成有时效的-Token" class="headerlink" title="ServiceAccountTokenVolumeProjection 生成有时效的 Token"></a>ServiceAccountTokenVolumeProjection 生成有时效的 Token</h4><p>参考：<a href="https://developer.aliyun.com/article/742572" target="_blank" rel="external nofollow noopener noreferrer">https://developer.aliyun.com/article/742572</a>，<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection" target="_blank" rel="external nofollow noopener noreferrer">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection</a>,<a href="https://www.alibabacloud.com/help/zh/doc-detail/160384.htm" target="_blank" rel="external nofollow noopener noreferrer">https://www.alibabacloud.com/help/zh/doc-detail/160384.htm</a><br>kube-apiserver<br><img src="/images/1586427070015-35b14a0a-4cf8-48cf-ae25-db4531f0b8b1.png" alt="image.png"><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--service-account-issuer=kubernetes.default.svc \</span><br><span class="line">--service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--api-audiences=kubernetes.default.svc \</span><br><span class="line">--feature-gates=BoundServiceAccountTokenVolume=true \</span><br></pre></td></tr></table></figure>

<p><br>kube-controller-manager<br><img src="/images/1586427180951-d8f9d830-5f94-4bb3-bbd6-640dd513b3f2.png" alt="image.png"><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--controllers=*,bootstrapsigner,tokencleaner,root-ca-cert-publisher \</span><br><span class="line">--feature-gates=BoundServiceAccountTokenVolume=true \</span><br></pre></td></tr></table></figure>

<p><br>示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">uhub.service.ucloud.cn/wxyz/etcd:3.4.3</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["ping"]</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">10.13</span><span class="number">.97</span><span class="number">.88</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/tokens</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">vault-token</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">build-robot</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vault-token</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">vault-token</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">600</span></span><br><span class="line">          <span class="attr">audience:</span> <span class="string">vault</span></span><br></pre></td></tr></table></figure>
<p><a name="lFBTT"></a></p>
<h4 id="kube-controller-manager-10252-port-in-use"><a href="#kube-controller-manager-10252-port-in-use" class="headerlink" title="kube-controller-manager 10252 port in use"></a>kube-controller-manager 10252 port in use</h4><p>在一定的概率下启动 kube-controller 会出现所需端口已被 kube-apiserver 占用的情况，这是因为 kube-apiserver 向内核申请一个随机端口用于和 etcd 通信，而恰好该端口是稍后 kube-controller-manger 所需的，由于多次出现这种巧合情况，所以对随机算法仍存疑？临时解决方法是调整随机端口范围，避开 10252 端口：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">net.ipv4.ip_local_port_range="12000</span> <span class="number">65535</span><span class="string">"</span></span><br></pre></td></tr></table></figure>


<p><a name="RC1F0"></a></p>
<h4 id="kubelet-启动时持续报错-node-not-found"><a href="#kubelet-启动时持续报错-node-not-found" class="headerlink" title="kubelet 启动时持续报错 node not found"></a>kubelet 启动时持续报错 node not found</h4><p>一般在经过几次报错后等节点注册成功就会正常，但是有些时候会出现持续报错，此时需要注意的是在 node not found 之前出现的错误，一般解决了这些前置错误就可以了。<br></p>
<p><a name="HFden"></a></p>
<h4 id="编译带-debug-信息的-kubernetes-组件"><a href="#编译带-debug-信息的-kubernetes-组件" class="headerlink" title="编译带 debug 信息的 kubernetes 组件"></a>编译带 debug 信息的 kubernetes 组件</h4><p>修改 <code>hack/lib/golang.sh b/hack/lib/golang.sh</code> 文件，将 <code>goldflags=&quot;${GOLDFLAGS:-} -s -w $(kube::version::ldflags)&quot;</code> 修改为 <code>goldflags=&quot;${GOLDFLAGS:-} $(kube::version::ldflags)&quot;</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 执行以下命令编译所需二进制程序：</span><br><span class="line">make hyperkube GOGCFLAGS=<span class="string">"all=-N -l"</span></span><br><span class="line">// 执行以下命令开始调试</span><br><span class="line">dlv <span class="built_in">exec</span> ./hyperkube</span><br></pre></td></tr></table></figure>


<p><a name="TWId1"></a></p>
<h4 id="subpath-挂载-configmap-文件不能自动更新的问题"><a href="#subpath-挂载-configmap-文件不能自动更新的问题" class="headerlink" title="subpath 挂载 configmap 文件不能自动更新的问题"></a>subpath 挂载 configmap 文件不能自动更新的问题</h4><p>参考：<a href="https://github.com/kubernetes/kubernetes/issues/50345#issuecomment-391888999" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/kubernetes/kubernetes/issues/50345#issuecomment-391888999</a>，不使用 subpath，另建一个目录专门挂载 configmap，从而不会覆盖原目录及其文件，在原目录建一个符号链接指向 confgimap 挂载路径，从而能够利用到自动更新机制。<br></p>
<p><a name="WPYBb"></a></p>
<h4 id="OOM-时-PreStop-钩子无法发挥作用"><a href="#OOM-时-PreStop-钩子无法发挥作用" class="headerlink" title="OOM 时 PreStop 钩子无法发挥作用"></a>OOM 时 PreStop 钩子无法发挥作用</h4><p>当 Pod 内存使用超出 Limit 时，会被内核 oom_killer 杀死，此时由于不是通过 apiserver 发出的删除 pod 调用也不是 Pod 自身的主动终止，所以 PreStop 并不会被触发，为了能够在内存使用超限被杀死前触发 PreStop，一种 walkaround 是通过一个监测内存使用量的程序在内存即将超限（例如 95% ）之前实施自杀，从而能够触发 PreStop ，可参考 ：<a href="https://github.com/16Bitt/kubemem" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/16Bitt/kubemem</a>。<br></p>
<p><a name="AiTBk"></a></p>
<h4 id="从-cronjob-手动触发一个-job"><a href="#从-cronjob-手动触发一个-job" class="headerlink" title="从 cronjob 手动触发一个 job"></a>从 cronjob 手动触发一个 job</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create job tmp-daily-report-job-02 --from=cronjob/job-1119051325-app-v1-0  -n data-infra</span><br></pre></td></tr></table></figure>
<p><a name="6J80J"></a></p>
<h4 id="在容器内修改系统参数"><a href="#在容器内修改系统参数" class="headerlink" title="在容器内修改系统参数"></a>在容器内修改系统参数</h4><p>大多数 namespace 级别的系统参数是安全的，可通过以下方式修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: centos-deployment</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: centos</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: centos</span><br><span class="line">    spec:</span><br><span class="line">      securityContext:</span><br><span class="line">        sysctls:</span><br><span class="line">          - name: kernel.shm_rmid_forced</span><br><span class="line">            value: <span class="string">"1"</span></span><br><span class="line">      containers:</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>
<p>对于非安全的 namespace 级别的参数可在 kubelet 启动参数中启用后才能进一步设置，<code>kubelet --allowed-unsafe-sysctls &#39;kernel.msg*,net.core.somaxconn&#39;</code>。<br>对于非安全的且为非 namespace 级别的内核参数，只能在宿主机上修改或者给容器添加特权后进入容器修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: centos-deployment</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: centos</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: centos</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - image: <span class="string">'uhub.service.ucloud.cn/ucloud/centos6-ssh:latest'</span></span><br><span class="line">          imagePullPolicy: Always</span><br><span class="line">          name: centos</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">              protocol: TCP</span><br><span class="line">          securityContext:</span><br><span class="line">            privileged: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><a name="8hqhL"></a></p>
<h4 id="Pod-SecurityContext-和-Container-SecurityContext"><a href="#Pod-SecurityContext-和-Container-SecurityContext" class="headerlink" title="Pod SecurityContext 和 Container SecurityContext"></a>Pod SecurityContext 和 Container SecurityContext</h4><p>参考：<a href="https://medium.com/kubernetes-tutorials/defining-privileges-and-access-control-settings-for-pods-and-containers-in-kubernetes-2cef08fc62b7" target="_blank" rel="external nofollow noopener noreferrer">https://medium.com/kubernetes-tutorials/defining-privileges-and-access-control-settings-for-pods-and-containers-in-kubernetes-2cef08fc62b7</a><br><a name="jDvuu"></a></p>
<h4 id="DaemonSet-的调度"><a href="#DaemonSet-的调度" class="headerlink" title="DaemonSet 的调度"></a>DaemonSet 的调度</h4><p>DaemonSet 相关的 Pod 并不由 kube-scheduler 进行调度，而是由 kube-controller 中的 DaemonSet controller 进行创建和调度，一般的 Pod 总是创建之后先进入 Pending 状态，而 DaemonSet 相关的 Pod 并没有 Pending 状态，Pod 优先级和抢占由 kube-scheduler 去执行，DaemonSet controller 并不会考虑这些，当然也可以通过一些设置（待补充）让调度工作由 kube-scheduler 去完成。DaemonSet controller 会自动为相关 Pod 添加一系列 toleration（包括对网络分区的容忍，对一些节点不可调度状态的容忍等），会造成 cordon 操作无法对 DaemonSet Pod 生效。参考：<a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#taints-and-tolerations" target="_blank" rel="external nofollow noopener noreferrer">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#taints-and-tolerations</a><br><a name="nTS6u"></a></p>
<h4 id="Pod-终止信息"><a href="#Pod-终止信息" class="headerlink" title="Pod 终止信息"></a>Pod 终止信息</h4><p>可以在 Pod 意外终止时，向 /dev/termination-log 文件中写入终止原因，方便 Kubernetes 获取信息并填入 Pod 状态字段中。通过以下方式可获取终止原因：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod termination-demo -o go-template=&quot;&#123;&#123;range .status.containerStatuses&#125;&#125;&#123;&#123;.lastState.terminated.message&#125;&#125;&#123;&#123;end&#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>另一方面可以通过 Pod.Spec.Containers[0].terminationMessagePath 自定义文件路径（默认是 /dev/termination-log ），也可以将 Pod.Spec.Containers[0].terminationMessagePolicy 设置为 FallbackToLogsOnError 告诉 Kubernetes 在指定文件内容为空且容器错误退出时，从容器日志中获取最后一段日志信息作为终止信息。参考：<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/determine-reason-pod-failure/" target="_blank" rel="external nofollow noopener noreferrer">https://kubernetes.io/docs/tasks/debug-application-cluster/determine-reason-pod-failure/</a><br><a name="Ae09P"></a></p>
<h4 id="Kubernetes-log-等级"><a href="#Kubernetes-log-等级" class="headerlink" title="Kubernetes log 等级"></a>Kubernetes log 等级</h4><p>一般调试开到 5 级即可，参考：<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md</a><br><a name="hu0pn"></a></p>
<h4 id="coredns"><a href="#coredns" class="headerlink" title="coredns"></a>coredns</h4><p>coredns 支持多种数据来源插件，对于 Kubernetes 的支持是通过 watch Service/Pod/Endpoints/Namespaces 资源动态增删解析记录实现的。<br><a name="F4p5X"></a></p>
<h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4><ul>
<li>重新加载配置</li>
</ul>
<p>启动时添加 –web.enable-lifecycle 参数，重新加载配置使用 <code>curl -X POST http://localhost:9090/-/reload</code> 。</p>
<ul>
<li>校验配置的有效性</li>
</ul>
<p>从 <a href="https://github.com/prometheus/prometheus/releases" target="_blank" rel="external nofollow noopener noreferrer">Prometheus 仓库</a>下载的可执行文件包含了 promtool 工具用于校验配置和 rule 的有效性。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;prometheus.yml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: prometehus</span><br><span class="line">static_configs:</span><br><span class="line">  - targets: [<span class="string">'localhost:9090'</span>]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">./promtool check config prometheus.yml</span><br><span class="line">Checking prometheus.yml</span><br><span class="line">  FAILED: parsing YAML file prometheus.yml: yaml: unmarshal errors:</span><br><span class="line">  line 3: field static_configs not found <span class="keyword">in</span> <span class="built_in">type</span> config.plain</span><br></pre></td></tr></table></figure>
<p><a name="nMrgw"></a></p>
<h4 id="让-Pod-在节点上均匀分布"><a href="#让-Pod-在节点上均匀分布" class="headerlink" title="让 Pod 在节点上均匀分布"></a>让 Pod 在节点上均匀分布</h4><p>在默认的调度策略下，优先考虑到的是资源使用比例的均衡，所以同一个 Deployment 所属的多个 Pod 副本可能集中分布在个别节点上，为了使 Pod 能够在拓扑结构上均匀分布到各个节点上，有两个策略可以考虑：</p>
<ul>
<li><p>当 Pod 副本数少于节点数量时，可为 Pod 添加 Pod 之间的反亲和性避免同类 Pod 调度到同一个节点上；</p>
</li>
<li><p>当 Pod 副本数比节点数量多时，反亲和性可能导致节点无处调度，或者仍然出现多个 Pod 调度到同一节点，一种更为通用的做法是使用 1.16 版本开始引入的 PodTopologySpreadConstraints，可以为 Pod 设置如下属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: uk8s-kubectl</span><br><span class="line">  name: uk8s-kubectl</span><br><span class="line">spec:</span><br><span class="line">  replicas: 18</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: uk8s-kubectl</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: uk8s-kubectl</span><br><span class="line">    spec:</span><br><span class="line">      topologySpreadConstraints:</span><br><span class="line">      - topologyKey: <span class="string">"kubernetes.io/hostname"</span> <span class="comment"># 以节点为粒度，也可以是 region、zone</span></span><br><span class="line">        maxSkew: 1 <span class="comment"># 允许的节点之间 Pod 数量的最大偏差</span></span><br><span class="line">        whenUnsatisfiable: ScheduleAnyway <span class="comment"># 当节点偏差大于设定值时的调度策略</span></span><br><span class="line">        labelSelector:  <span class="comment"># 选中需应用此规则的 Pod </span></span><br><span class="line">          matchLabels:</span><br><span class="line">            k8s-app: uk8s-kubectl</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>
<p><a name="yR4Fi"></a></p>
<h4 id="升级-Kubernetes-组件和-etcd"><a href="#升级-Kubernetes-组件和-etcd" class="headerlink" title="升级 Kubernetes 组件和 etcd"></a>升级 Kubernetes 组件和 etcd</h4><p>参考：<a href="https://platform9.com/blog/kubernetes-upgrade-the-definitive-guide-to-do-it-yourself/" target="_blank" rel="external nofollow noopener noreferrer">https://platform9.com/blog/kubernetes-upgrade-the-definitive-guide-to-do-it-yourself/</a><br><a name="KbLQx"></a></p>
<h4 id="查看-Kubernetes-每个版本的发布日志"><a href="#查看-Kubernetes-每个版本的发布日志" class="headerlink" title="查看 Kubernetes 每个版本的发布日志"></a>查看 Kubernetes 每个版本的发布日志</h4><p><a href="https://relnotes.k8s.io/" target="_blank" rel="external nofollow noopener noreferrer">https://relnotes.k8s.io/</a><br><a name="reRkH"></a></p>
<h4 id="为系统关键组件设置高优先级"><a href="#为系统关键组件设置高优先级" class="headerlink" title="为系统关键组件设置高优先级"></a>为系统关键组件设置高优先级</h4><p>对于部署于集群中的关键组件如 CoreDNS，可通过为 Pod 设置 priorityClassName: system-cluster-critical，来提高优先级，降低集群资源不足时被驱逐后持续 Pending 的概率，system-node-critical 优先级最高，高于 system-cluster-critical。<br><a name="ND1Cw"></a></p>
<h4 id="kube-proxy-的-nftables-实现"><a href="#kube-proxy-的-nftables-实现" class="headerlink" title="kube-proxy 的 nftables 实现"></a>kube-proxy 的 nftables 实现</h4><p><a href="https://github.com/zevenet/nftlb" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/zevenet/nftlb</a>，<a href="https://github.com/sbezverk/nfproxy" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/sbezverk/nfproxy</a>，<a href="https://github.com/zevenet/kube-nftlb" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/zevenet/kube-nftlb</a><br><a name="8T7qF"></a></p>
<h4 id="十二因素应用"><a href="#十二因素应用" class="headerlink" title="十二因素应用"></a>十二因素应用</h4></li>
<li><p>十二因素的提出早于 Kubernetes 的大规模使用，但是一些因素和基于 Kubernetes 的服务开发部署有着很好的吻合。可参考： <a href="https://skyao.io/learning-cloudnative/factor/" target="_blank" rel="external nofollow noopener noreferrer">https://skyao.io/learning-cloudnative/factor/</a> ，<a href="https://blog.csdn.net/zeb_perfect/article/details/52536411" target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/zeb_perfect/article/details/52536411</a>， <a href="https://12factor.net/" target="_blank" rel="external nofollow noopener noreferrer">https://12factor.net/</a></p>
</li>
<li><p>关于基准代码的理解：每个应用应该使用单独的代码仓库，如果多个应用有需要共享的基准代码，则应当将这部分共享代码组织为一个单独的代码仓库。</p>
<table>
<thead>
<tr>
<th align="center">Factor</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Codebase<br>基准代码</td>
<td align="center">One codebase tracked in revision control, many deploys<br>一份基准代码，多份部署</td>
</tr>
<tr>
<td align="center">Dependencies<br>依赖</td>
<td align="center">Explicitly declare and isolate dependencies<br>显式声明依赖关系</td>
</tr>
<tr>
<td align="center">Config<br>配置</td>
<td align="center">Store config in the environment<br>在环境中存储配置</td>
</tr>
<tr>
<td align="center">Backing services<br>后端服务</td>
<td align="center">Treat backing services as attached resources<br>把后端服务当作附加资源</td>
</tr>
<tr>
<td align="center">Build, release, run<br>构建，发布，运行</td>
<td align="center">Strictly separate build and run stages<br>严格分离构建和运行</td>
</tr>
<tr>
<td align="center">Processes<br>进程</td>
<td align="center">Execute the app as one or more stateless processes<br>以一个或多个无状态进程运行应用</td>
</tr>
<tr>
<td align="center">Port binding<br>端口绑定</td>
<td align="center">Export services via port binding<br>通过端口绑定提供服务</td>
</tr>
<tr>
<td align="center">Concurrency<br>并发</td>
<td align="center">Scale out via the process model<br>通过进程模型进行扩展</td>
</tr>
<tr>
<td align="center">Disposability<br>易处理</td>
<td align="center">Maximize robustness with fast startup and graceful shutdown<br>快速启动和优雅终止可最大化健壮性</td>
</tr>
<tr>
<td align="center">Dev/prod parity<br>开发环境与线上环境等价</td>
<td align="center">Keep development, staging, and production as similar as possible<br>尽可能的保持开发，预发布，线上环境相同</td>
</tr>
<tr>
<td align="center">Logs<br>日志</td>
<td align="center">Treat logs as event streams<br>把日志当作事件流</td>
</tr>
<tr>
<td align="center">Admin processes<br>管理进程</td>
<td align="center">Run admin/management tasks as one-off processes<br>后台管理任务当作一次性进程运行</td>
</tr>
</tbody></table>
</li>
</ul>
<p><a name="COum0"></a></p>
<h4 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h4><ul>
<li>helm init 使用 azure 镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm init --stable-repo-url  http://mirror.azure.cn/kubernetes/charts/</span><br><span class="line">helm repo add incubator http://mirror.azure.cn/kubernetes/charts-incubator/</span><br></pre></td></tr></table></figure>


<ul>
<li>awk 打印第一列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n rook-ceph -owide |grep -i Evicted | awk &apos;&#123;print $1&#125;&apos;| xargs kubectl delete pod -n rook-ceph</span><br></pre></td></tr></table></figure>


<ul>
<li>cut 获取第一列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n rook-ceph | grep -i Evicted | sed &apos;s/\s\s*/ /g&apos; |cut -d&quot; &quot; -f1 | xargs kubectl delete pod -n rook-ceph --force --grace-period=0</span><br></pre></td></tr></table></figure>


<ul>
<li>列出所有位于指定节点的 pod<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces -o wide --field-selector spec.nodeName=10.25.150.64</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p><a name="n8S4L"></a></p>
<h4 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h4>
    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/post/c851306f.html" rel="bookmark">统一认证中心方案调研</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/post/dc552b49.html" rel="bookmark">Centos 编译安装 zfs</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/post/bda105fe.html" rel="bookmark">ArchLinux 常用命令</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/post/e8bac896.html" rel="bookmark">Ceph 常用操作</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/post/5fddf106.html" rel="bookmark">Git 常用命令</a></div>
    </li>
  </ul>

        <div class="reward-container">
  <div></div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="夏印昌 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>


      <div>
        
          <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">本文到此结束　<i class="fa fa-heart"></i>　感谢您的阅读</div>
    
</div>
        
      </div>

      <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
      </script>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/post/b489449e.html" rel="next" title="Linux 实用命令集合">
                  <i class="fa fa-chevron-left"></i> Linux 实用命令集合
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/post/a68ff6.html" rel="prev" title="前端知识点滴">
                  前端知识点滴 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC80MjY3Ni8xOTIyMw=="></div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#kubectl"><span class="nav-number">1.</span> <span class="nav-text">kubectl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Patch-更新的三种操作"><span class="nav-number">2.</span> <span class="nav-text">Patch 更新的三种操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#taint"><span class="nav-number">3.</span> <span class="nav-text">taint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#toleration"><span class="nav-number">4.</span> <span class="nav-text">toleration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#etcd"><span class="nav-number">5.</span> <span class="nav-text">etcd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nodeName-nodeSelector-Affinity"><span class="nav-number">6.</span> <span class="nav-text">nodeName/nodeSelector/Affinity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#逻辑上的隔离"><span class="nav-number">7.</span> <span class="nav-text">逻辑上的隔离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#节点状态和-Taint"><span class="nav-number">8.</span> <span class="nav-text">节点状态和 Taint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kubernetes-go-client"><span class="nav-number">9.</span> <span class="nav-text">Kubernetes-go-client</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#证书"><span class="nav-number">10.</span> <span class="nav-text">证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kubeadm"><span class="nav-number">11.</span> <span class="nav-text">Kubeadm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Helm"><span class="nav-number">12.</span> <span class="nav-text">Helm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加自定义-DNS-记录"><span class="nav-number">13.</span> <span class="nav-text">添加自定义 DNS 记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向容器添加-hosts-记录"><span class="nav-number">14.</span> <span class="nav-text">向容器添加 hosts 记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress-nginx"><span class="nav-number">15.</span> <span class="nav-text">ingress-nginx</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CronJob-与-Job"><span class="nav-number">16.</span> <span class="nav-text">CronJob 与 Job</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#field-selector-和-labels-selector"><span class="nav-number">17.</span> <span class="nav-text">field-selector 和 labels-selector</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-subPath-挂载-Volume"><span class="nav-number">18.</span> <span class="nav-text">使用 subPath 挂载 Volume</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建并使用-imagePullSecrets"><span class="nav-number">19.</span> <span class="nav-text">创建并使用 imagePullSecrets</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sealos-部署-Kubernetes"><span class="nav-number">20.</span> <span class="nav-text">sealos 部署 Kubernetes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优雅地删除节点"><span class="nav-number">21.</span> <span class="nav-text">优雅地删除节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重启容器而非删除"><span class="nav-number">22.</span> <span class="nav-text">重启容器而非删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServiceAccountTokenVolumeProjection-生成有时效的-Token"><span class="nav-number">23.</span> <span class="nav-text">ServiceAccountTokenVolumeProjection 生成有时效的 Token</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kube-controller-manager-10252-port-in-use"><span class="nav-number">24.</span> <span class="nav-text">kube-controller-manager 10252 port in use</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubelet-启动时持续报错-node-not-found"><span class="nav-number">25.</span> <span class="nav-text">kubelet 启动时持续报错 node not found</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编译带-debug-信息的-kubernetes-组件"><span class="nav-number">26.</span> <span class="nav-text">编译带 debug 信息的 kubernetes 组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#subpath-挂载-configmap-文件不能自动更新的问题"><span class="nav-number">27.</span> <span class="nav-text">subpath 挂载 configmap 文件不能自动更新的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OOM-时-PreStop-钩子无法发挥作用"><span class="nav-number">28.</span> <span class="nav-text">OOM 时 PreStop 钩子无法发挥作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从-cronjob-手动触发一个-job"><span class="nav-number">29.</span> <span class="nav-text">从 cronjob 手动触发一个 job</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在容器内修改系统参数"><span class="nav-number">30.</span> <span class="nav-text">在容器内修改系统参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pod-SecurityContext-和-Container-SecurityContext"><span class="nav-number">31.</span> <span class="nav-text">Pod SecurityContext 和 Container SecurityContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DaemonSet-的调度"><span class="nav-number">32.</span> <span class="nav-text">DaemonSet 的调度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pod-终止信息"><span class="nav-number">33.</span> <span class="nav-text">Pod 终止信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kubernetes-log-等级"><span class="nav-number">34.</span> <span class="nav-text">Kubernetes log 等级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#coredns"><span class="nav-number">35.</span> <span class="nav-text">coredns</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Prometheus"><span class="nav-number">36.</span> <span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#让-Pod-在节点上均匀分布"><span class="nav-number">37.</span> <span class="nav-text">让 Pod 在节点上均匀分布</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#升级-Kubernetes-组件和-etcd"><span class="nav-number">38.</span> <span class="nav-text">升级 Kubernetes 组件和 etcd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看-Kubernetes-每个版本的发布日志"><span class="nav-number">39.</span> <span class="nav-text">查看 Kubernetes 每个版本的发布日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为系统关键组件设置高优先级"><span class="nav-number">40.</span> <span class="nav-text">为系统关键组件设置高优先级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kube-proxy-的-nftables-实现"><span class="nav-number">41.</span> <span class="nav-text">kube-proxy 的 nftables 实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十二因素应用"><span class="nav-number">42.</span> <span class="nav-text">十二因素应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#常用操作"><span class="nav-number">43.</span> <span class="nav-text">常用操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#书籍"><span class="nav-number">44.</span> <span class="nav-text">书籍</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="夏印昌" src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">夏印昌</p>
  <div class="site-description" itemprop="description">云计算从业者，全栈攻城狮</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xiayinchang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiayinchang" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/mailto:xiayinchang@gmail.com" title="E-Mail → mailto:xiayinchang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank">沪ICP备17024006号 </a>
  </div>

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">夏印昌</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">278k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:12</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Mist</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;" z>
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  
  <script color="153,153,153" opacity="0.5" zindex="-1" count="99" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  <script src="/js/local-search.js"></script>













  

  

<script>
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

</body>
</html>
